<!DOCTYPE html>
<html>
<head>
    <title>TEST</title>
    <link rel="stylesheet" type="text/css" href="/easyrtc/easyrtc.css"/>
    <!-- Assumes global locations for socket.io.js and easyrtc.js -->
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/easyrtc/easyrtc.js"></script>
    <script type="text/javascript" src="/easyrtc/easyrtc_ft.js"></script>

</head>
<body onload="connect()">
<div id="iam">Obtaining ID...</div>
<br/>
<div id="peerZone">
</div>
<div id="fileDropper" style="background: red; color: white;">
    <br><br><br><br><br><br>DROP HERE<br><br><br><br><br><br>
</div>

<img id="photo" src="">

<script>
    var selfEasyrtcid;

    function connect() {

        // easyrtc.enableDataChannels(true);
        // easyrtc.enableVideo(false);
        // easyrtc.enableAudio(false);
        easyrtc.setRoomOccupantListener(roomOccListener);

        easyrtc.setDataChannelOpenListener(function (easyrtcid, usesPeer) {
            // var obj = document.getElementById(buildDragNDropName(easyrtcid));
            // if (!obj) {
            //     console.log("no such object ");
            // }
            // obj.addClass("connected");
            // obj.removeClass("notConnected");
        });

        easyrtc.setDataChannelCloseListener(function (easyrtcid) {
            // buildDragNDropName(easyrtcid).addClass("notConnected");
            // buildDragNDropName(easyrtcid).removeClass("connected");
        });

        easyrtc.connect("TEST", loginSuccess, loginFailure);
    }

    function roomOccListener(roomName, occupants, isPrimary) {
        // console.log(occupants);

        var dropper = $("#fileDropper");

        // var noDCs = {}; // which users don"t support data channels

        var fileSender = null;
        var fileSender2 = null;

        function filesHandler(files) {
            // console.log(files);

            // if we haven"t eastablished a connection to the other party yet, do so now,
            // and on completion, send the files. Otherwise send the files now.
            // var timer = null;
            // if (easyrtc.getConnectStatus(easyrtcid) === easyrtc.NOT_CONNECTED && noDCs[easyrtcid] === undefined) {
            //     //
            //     // calls between firefrox and chrome ( version 30) have problems one way if you
            //     // use data channels.
            //     //
            //
            // }
            // else if (easyrtc.getConnectStatus(easyrtcid) === easyrtc.IS_CONNECTED || noDCs[easyrtcid]) {
            if (!fileSender) {
                fileSender = easyrtc_ft.buildFileSender(Object.keys(occupants)[0], null, null);
            }
            fileSender(files, true /* assume binary */);
            if (!fileSender2) {
                fileSender2 = easyrtc_ft.buildFileSender(Object.keys(occupants)[1], null, null);
            }
            fileSender2(files, true /* assume binary */);
            // }
            // else {
            //     easyrtc.showError("user-error", "Wait for the connection to complete before adding more files!");
            // }
        }

        // jQuerySelector.get(0) converts to DOMString
        easyrtc_ft.buildDragNDropRegion(dropper.get(0), filesHandler);
    }

    // function acceptRejectCB(otherGuy, fileNameList, wasAccepted) {
    //
    //     var receiveBlock = $('#' + buildReceiveAreaName(otherGuy));
    //     receiveBlock.empty();
    //     receiveBlock.style.display = "inline-block";
    //
    //     //
    //     // list the files being offered
    //     //
    //     receiveBlock.appendChild(document.createTextNode("Files offered"));
    //     receiveBlock.appendChild(document.createElement("br"));
    //     for (var i = 0; i < fileNameList.length; i++) {
    //         receiveBlock.appendChild(
    //             document.createTextNode("  " + fileNameList[i].name + "(" + fileNameList[i].size + " bytes)"));
    //         receiveBlock.appendChild(document.createElement("br"));
    //     }
    //     //
    //     // provide accept/reject buttons
    //     //
    //     var button = document.createElement("button");
    //     button.appendChild(document.createTextNode("Accept"));
    //     button.onclick = function () {
    //         receiveBlock.empty();
    //         wasAccepted(true);
    //     };
    //     receiveBlock.appendChild(button);
    //
    //     button = document.createElement("button");
    //     button.appendChild(document.createTextNode("Reject"));
    //     button.onclick = function () {
    //         wasAccepted(false);
    //         receiveBlock.style.display = "none";
    //     };
    //     receiveBlock.appendChild(button);
    // }

    function DOWNLOAD(otherGuy, blob, filename) {
        // var myReader = new FileReader();

        // myReader.addEventListener("loadend", function(e){
            var imageUrl = window.URL.createObjectURL( blob );
            var img = document.querySelector( "#photo" );
            console.log(imageUrl);
            img.src = imageUrl;
        // });
        //
        // myReader.readAsText(blob);

        // easyrtc_ft.saveAs(blob, filename);
    }

    function loginSuccess(easyrtcid) {
        selfEasyrtcid = easyrtcid;
        document.getElementById("iam").innerHTML = "I am " + easyrtcid;
        easyrtc_ft.buildFileReceiver(function(otherGuy, filenamelist, wasAccepted) {
            // console.log("START");
            // console.log(otherGuy);
            // console.log(filenamelist);
            // console.log(wasAccepted);
            // console.log("END");
            wasAccepted(true);
        }, DOWNLOAD, function(otherGuy, status) {  /*console.log("status:" + JSON.stringify(status))*/});
    }

    function loginFailure(errorCode, message) {
        easyrtc.showError(errorCode, message);
    }
</script>
</body>
</html>
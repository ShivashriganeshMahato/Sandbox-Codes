<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>

    <link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="css/animate.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

    <!-- Assumes global locations for socket.io.js and easyrtc.js -->
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/easyrtc/easyrtc.js"></script>
    <script type="text/javascript" src="/easyrtc/easyrtc_ft.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js"></script>
</head>
<body ng-app="chat">
<div ng-cloak ng-controller="chatCtrl">
    <div id="rooms">
		<div style="margin:auto; text-align: center; padding-top: 10%">
		<img class="friendspic" ng-src="https://ui-avatars.com/api/?name={{user.name}}&font-size=0.5&rounded=true&size=60&color=ffffff&background=009900"/>
		<div>
		<p style="margin: 0">{{user.name}}</p>
		<p style="font-size: 0.8em; color:lightgray;margin-top:0">@{{user.uname}}</p>
			</div>
			</div>
        <ul id="roomList">
            <li ng-repeat="room in rooms track by $index">
                <span onclick="showChatInput()" ng-click="chatRoom.changeRoom($index)">
                    {{room.name}}&nbsp;
                    <span ng-if="room.unread > 0" class="redTxt">{{room.unread}}</span>
                </span>
            </li>
        </ul>
	<button id="addRoom" onclick="showCreateRoomForm()"><i class="fas fa-plus"></i></button>
    </div>
   <div id="friends" class="sidenav">
        <div ng-if="chatRoom.isARoomSelected()">
			<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
			<button class="redBtn"
					ng-click="chatClient.leaveRoom(chatRoom.getSelectedRoom())" style="width: 100%;font-family: 'Lato'"><i class="fas fa-sign-out-alt fa-2x" style="color: white"></i></button>
            <ul id="friendsList" style="padding: 0%;">
                <li style="padding: 5%;overflow:  auto;border-radius: 50px;width:  75%;margin: 2.5% auto;background-color:  white;border:solid 1.5px rebeccapurple;height: 50px"
ng-repeat="member in chatRoom.getMembers() track by $index">
                    <span ng-if="member.isOnline">
                        <img class="friendspic" ng-src="https://ui-avatars.com/api/?name={{member.name}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=009900" style="float: left"/>
                        <span ng-if="member.isTyping === chatRoom.getSelectedRoom().id">
                            <br>(typing...)
                        </span>
                    </span>
					<span ng-if="!member.isOnline">
                        <img class="friendspic" ng-src="https://ui-avatars.com/api/?name={{member.name}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=b20000" style="float:left"/>
                        <span ng-if="member.isTyping === chatRoom.getSelectedRoom().id">
                            <br>(typing...)
                        </span>
                    </span>
					<div>
                    <input class="redBtn" style="float: left;height: 20px;margin-bottom: 5px; margin-left: 5%;background-color:  mediumvioletred;border-radius: 20px;width: 60%;color: white" type="submit" value="Kick From Room"
                           ng-click="chatRoom.removeUser(member.id)"/>
                    <br/>
                    <span ng-if="chatClient.hasFriend(member)">
                        <input class="yellowBtn" type="submit" value="Remove Friend"
                               ng-click="chatClient.unfriend(member)"/>
                    </span>
                    <span ng-if="!chatClient.hasFriend(member)">
                        <input class="blueBtn" style="width: 60%;height: 20px;margin-left: 5%;margin-top: 5px;background-color:  mediumpurple;border-radius: 20px;color: white"type="submit" value="Add Friend"
                               ng-click="chatClient.sendFriendRequest(member)"/>
                    </span>
						</div>
                </li>
                <li ng-repeat="friend in chatClient.getFriends() track by $index">
                    <span ng-if="!chatRoom.hasMember(friend)">
                        {{friend.name}}
                        <input class="greenBtn" type="submit" value="Add To Room"
                               ng-click="chatRoom.addFriendAsMember(friend)"/>
                        <input class="yellowBtn" type="submit" value="Remove Room"
                               ng-click="chatClient.unfriend(friend)"/>
                    </span>
                </li>
            </ul>
        </div>
    </div>
    <div id="info">
        <span ng-if="chatRoom.isARoomSelected()">
            <h2 style="float:left;margin: 0 2%">{{chatRoom.getSelectedRoom().name}}</h2>
			<a href="javascript:openNav()"><i class="fas fa-ellipsis-h fa-2x" style="color: gray;float: right;position: relative;margin-right: 2%"></i></a>
        </span>
        <span ng-if="!chatRoom.isARoomSelected()">
            <h2 style="float: left;margin: 0 2%">No room selected</h2>
        </span>
    </div>
    <div id="input">
		<button id="attachBtn" onclick="showAttachmentForm()" style="color: white;" class="blueBtn" style="float: left;"><i class="fas fa-paperclip"></i></button>
        <input id="inputBox" ng-model="chatInput">
        <button id="sendBtn"
				ng-click="chatRoom.sendChat(chatInput)" onclick="document.getElementById('inputBox').value=''"><i style="color: white" class="fas fa-paper-plane"></i></button>    </div>
    <div id="log">
        <div ng-if="chatRoom.isARoomSelected()">
            <ul id="chatList">
                <li ng-class="typeof(chat) === 'string' ? 'texter' : 'temp'" ng-repeat="chat in rooms[selRoomIndex].chats track by $index">
                    <span ng-if="typeof(chat) === 'string'">
						<span ng-if="!chat.startsWith(user.uname)">
							<div class="tooltip">
							<img ng-src="https://ui-avatars.com/api/?name={{chat.split(' ')[1] + '+' + chat.substr(0, chat.indexOf(':')).split(' ')[chat.substr(0, chat.indexOf(':')).split(' ').length - 1]}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=663399" style="float: left"/>
							<span class="tooltiptext">{{chat.split(' ')[1] + chat.substr(0, chat.indexOf(':')).split(' ')[chat.substr(0, chat.indexOf(':')).split(' ').length - 1]}}</span>
							</div>
							<p ng-class="chat.startsWith(user.uname) ? 'container darker' : 'container'">
								{{chat.substr(chat.indexOf(':') + 1)}}
							</p>
						</span>
						<span ng-if="chat.startsWith(user.uname)">
							<img ng-src="https://ui-avatars.com/api/?name={{chat.split(' ')[1] + '+' + chat.substr(0, chat.indexOf(':')).split(' ')[chat.substr(0, chat.indexOf(':')).split(' ').length - 1]}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=663399" style="float: right"/>
							<p ng-class="chat.startsWith(user.uname) ? 'container darker' : 'container'">
								{{chat.substr(chat.indexOf(':') + 1)}}
							</p>
						</span>
                    </span>
                    <span ng-if="typeof(chat) === 'object'">
						<span ng-if="!chat.startsWith(user.uname)">
							<div class="tooltip">
						<img ng-src="https://ui-avatars.com/api/?name={{chat.fromName.split(' ')[0] + '+' + chat.fromName.split(' ')[chat.fromName.split(' ').length - 1]}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=663399" style="float: left"/>
								<span class="tooltiptext">{{chat.fromName.split(' ')[0] + chat.fromName.split(' ')[chat.fromName.split(' ').length - 1]}}</span>
							</div>
                            <!--{{chat.fromUname + " " + chat.fromName}}-->
                            <img style="width: 40%;margin: 0% 2%;" ng-if="chat.type.includes('image')" src="{{chat.url}}">
                            <span ng-if="!chat.type.includes('image')"><input class="greenBtn" type="submit" style="height: 50px;margin-left: 1%;bottom: 20px" value="{{chat.name}}" ng-click="chat.download()"/></span>
						</span>
						<span ng-if="chat.startsWith(user.uname)">
							<img style="width: 40%;margin: 0% 2%;" ng-src="https://ui-avatars.com/api/?name={{chat.fromName.split(' ')[0] + '+' + chat.fromName.split(' ')[chat.fromName.split(' ').length - 1]}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=663399" style="float: right"/>
                            <!--{{chat.fromUname + " " + chat.fromName}}-->
                            <img ng-if="chat.type.includes('image')" src="{{chat.url}}">
                            <span ng-if="!chat.type.includes('image')">{{chat.name}}</span>
                            <br/>
                            <input class="greenBtn" type="submit" value="Download" ng-click="chat.download()"/>
                        </span>
                    </span>
                </li>
            </ul>
        </div>
    </div>
    <div id="createRoomForm" class="modal">
		<div class="modal-content">
				<span class="close" onclick="closeCreateRoomForm()" >&times;</span>
			<form>
				<fieldset>
				<label for="createRoomName">Name:</label><input id="createRoomName" class="inputname" type="text" ng-model="createRoomName"></fieldset><br>
				<fieldset>
				Members:
				<ul style="list-style: none">
        <li style="float: left;margin-right: 10%" ng-repeat="member in createRoomFormMembers track by $index" id="createRoomMembers">
                <span ng-click="removeCreateRoomFormMember(member)">
						<div class="tooltip">
						<img ng-src="https://ui-avatars.com/api/?name={{member.name}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=663399"/>
						<span class="tooltiptext">{{member.name}}</span>
							</div>
                </span>
            </li>
					</ul></fieldset>
        <br>
				<fieldset>Friends:
			<ul style="list-style: none" id="createRoomFriends">
            <li style="float:left;margin-right: 10%" ng-repeat="friend in friends track by $index">
                <span ng-if="!createRoomFormMemberNames.includes(friend.name)">
                    <span class="tooltip" ng-click="addCreateRoomFormMember(friend)">
						<img ng-src="https://ui-avatars.com/api/?name={{friend.name}}&font-size=0.3&rounded=true&size=50&color=ffffff&background=663399"/>
						<span class="tooltiptext">{{friend.name}}</span>
                    </span>
                </span>
            </li>
        </ul>
					</fieldset>
			</form>
			<button class="greenBtn" value="Create" style="float: right;" onclick="closeCreateRoomForm()"
					ng-click="chatClient.createRoom(createRoomName, createRoomFormMembers)"><i class="fas fa-check fa-2x"></i></button>
    </div>
		</div>
	<div id="attachForm" class="modal">
    <div class="modal-content">
		<div class="modal-header">
		Attach File Here
		<span id="attachCancelBtn" class="close" onclick="closeAttachmentForm()"ng-click="chatClient.clearFilesToSend()" >&times;</span>
		</div>
		<div class="modal-body">
		<ul id="attachments">
            <li ng-repeat="file in filesToSend track by $index">
                {{file.name}}
            </li>
        </ul>
		</div>
		<div class="modal-footer">
			<button id="attachSendBtn" onclick="closeAttachmentForm()" ng-click="chatClient.sendCollectedFiles()" class="greenBtn" style="float: right;"><i class="far fa-paper-plane fa-2x"></i></button>
		</div>
    </div>
		</div>
</div>

<script src="scripts/models.js"></script>
<script src="scripts/chatClient.js"></script>
<script>
	function openNav() {
    document.getElementById("friends").style.width = "250px";
}

function closeNav() {
    document.getElementById("friends").style.width = "0";
}
    function showCreateRoomForm() {
        $('#createRoomForm').css('display', 'block');
    }

    function closeCreateRoomForm() {
        $('#createRoomMembers').empty();
        $('#createRoomName').val('');
        $('#createRoomForm').css('display', 'none');
    }

    function showAttachmentForm() {
        $('#attachForm').css('display', 'block');
    }

    function closeAttachmentForm() {
        $('#attachForm').css('display', 'none');
    }

    function showChatInput() {
        $('#input').css('display', 'block');
    }

    function closeChatInput() {
        $('#input').css('display', 'none');
    }
</script>

</body>
</html>